#include "app_type.h"

#include "fakefat.h"

const uint8_t fat12_mbr[512] = 
{
	0xEB,0x3C,0x90,0x4D,0x53,0x44,0x4F,0x53,0x35,0x2E,0x30,0x00,0x02,0x01,0x01,0x00,
	0x01,0x20,0x00,0x00,0x01,0xF8,0x01,0x00,0x20,0x00,0x40,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x80,0x00,0x29,0x76,0xAB,0xA5,0x40,0x4E,0x6F,0x20,0x4E,0x41,
	0x4D,0x45,0x20,0x20,0x20,0x20,0x46,0x41,0x54,0x31,0x32,0x20,0x20,0x20,0x33,0xC9,
	0x8E,0xD1,0xBC,0xF0,0x7B,0x8E,0xD9,0xB8,0x00,0x20,0x8E,0xC0,0xFC,0xBD,0x00,0x7C,
	0x38,0x4E,0x24,0x7D,0x24,0x8B,0xC1,0x99,0xE8,0x3C,0x01,0x72,0x1C,0x83,0xEB,0x3A,
	0x66,0xA1,0x1C,0x7C,0x26,0x66,0x3B,0x07,0x26,0x8A,0x57,0xFC,0x75,0x06,0x80,0xCA,
	0x02,0x88,0x56,0x02,0x80,0xC3,0x10,0x73,0xEB,0x33,0xC9,0x8A,0x46,0x10,0x98,0xF7,
	0x66,0x16,0x03,0x46,0x1C,0x13,0x56,0x1E,0x03,0x46,0x0E,0x13,0xD1,0x8B,0x76,0x11,
	0x60,0x89,0x46,0xFC,0x89,0x56,0xFE,0xB8,0x20,0x00,0xF7,0xE6,0x8B,0x5E,0x0B,0x03,
	0xC3,0x48,0xF7,0xF3,0x01,0x46,0xFC,0x11,0x4E,0xFE,0x61,0xBF,0x00,0x00,0xE8,0xE6,
	0x00,0x72,0x39,0x26,0x38,0x2D,0x74,0x17,0x60,0xB1,0x0B,0xBE,0xA1,0x7D,0xF3,0xA6,
	0x61,0x74,0x32,0x4E,0x74,0x09,0x83,0xC7,0x20,0x3B,0xFB,0x72,0xE6,0xEB,0xDC,0xA0,
	0xFB,0x7D,0xB4,0x7D,0x8B,0xF0,0xAC,0x98,0x40,0x74,0x0C,0x48,0x74,0x13,0xB4,0x0E,
	0xBB,0x07,0x00,0xCD,0x10,0xEB,0xEF,0xA0,0xFD,0x7D,0xEB,0xE6,0xA0,0xFC,0x7D,0xEB,
	0xE1,0xCD,0x16,0xCD,0x19,0x26,0x8B,0x55,0x1A,0x52,0xB0,0x01,0xBB,0x00,0x00,0xE8,
	0x3B,0x00,0x72,0xE8,0x5B,0x8A,0x56,0x24,0xBE,0x0B,0x7C,0x8B,0xFC,0xC7,0x46,0xF0,
	0x3D,0x7D,0xC7,0x46,0xF4,0x29,0x7D,0x8C,0xD9,0x89,0x4E,0xF2,0x89,0x4E,0xF6,0xC6,
	0x06,0x96,0x7D,0xCB,0xEA,0x03,0x00,0x00,0x20,0x0F,0xB6,0xC8,0x66,0x8B,0x46,0xF8,
	0x66,0x03,0x46,0x1C,0x66,0x8B,0xD0,0x66,0xC1,0xEA,0x10,0xEB,0x5E,0x0F,0xB6,0xC8,
	0x4A,0x4A,0x8A,0x46,0x0D,0x32,0xE4,0xF7,0xE2,0x03,0x46,0xFC,0x13,0x56,0xFE,0xEB,
	0x4A,0x52,0x50,0x06,0x53,0x6A,0x01,0x6A,0x10,0x91,0x8B,0x46,0x18,0x96,0x92,0x33,
	0xD2,0xF7,0xF6,0x91,0xF7,0xF6,0x42,0x87,0xCA,0xF7,0x76,0x1A,0x8A,0xF2,0x8A,0xE8,
	0xC0,0xCC,0x02,0x0A,0xCC,0xB8,0x01,0x02,0x80,0x7E,0x02,0x0E,0x75,0x04,0xB4,0x42,
	0x8B,0xF4,0x8A,0x56,0x24,0xCD,0x13,0x61,0x61,0x72,0x0B,0x40,0x75,0x01,0x42,0x03,
	0x5E,0x0B,0x49,0x75,0x06,0xF8,0xC3,0x41,0xBB,0x00,0x00,0x60,0x66,0x6A,0x00,0xEB,
	0xB0,0x4E,0x54,0x4C,0x44,0x52,0x20,0x20,0x20,0x20,0x20,0x20,0x0D,0x0A,0x52,0x65,
	0x6D,0x6F,0x76,0x65,0x20,0x64,0x69,0x73,0x6B,0x73,0x20,0x6F,0x72,0x20,0x6F,0x74,
	0x68,0x65,0x72,0x20,0x6D,0x65,0x64,0x69,0x61,0x2E,0xFF,0x0D,0x0A,0x44,0x69,0x73,
	0x6B,0x20,0x65,0x72,0x72,0x6F,0x72,0xFF,0x0D,0x0A,0x50,0x72,0x65,0x73,0x73,0x20,
	0x61,0x6E,0x79,0x20,0x6B,0x65,0x79,0x20,0x74,0x6F,0x20,0x72,0x65,0x73,0x74,0x61,
	0x72,0x74,0x0D,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xAC,0xCB,0xD8,0x55,0xAA};

uint8_t fat12_fat[] = 
{
	0xF0, 0xFF, 0xFF, 0xFF, 0x0F
};

uint8_t fat12_root[] = 
{
	'F', 'a', 'k', 'e', 'F', 'A', 'T', '1', '2', ' ', ' ', 0x08,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0xD4,0x28,0x4B,0x3D,0x00,0x00,0x00,0x00,0x00,0x00,
	
//  0..7:                              8..10:              11:            14..15:
//  FileName                           Ext                 Attr           CreateT
	'F', 'I', 'L', 'E', 'N', 'A', 'M', 'E', 'T', 'X', 'T', 0x20,0x00,0x75,0x09,0x4E,
//  16..17:   18..19              22..23:   24..25:   26..27:   28..31:
//  CreateD   LastAccD            LastWT    LastWD    Cluster   ByteSize
	0xe3,0x40,0xe3,0x40,0x00,0x00,0x0a,0x4e,0xe3,0x40,0x02,0x00,0x00,0x02,0x00,0x00
};

uint8_t fat12_file[] = 
{
	'h', 'e', 'l', 'l', 'o', ',', 'w', 'o', 'r', 'l', 'd', '!'
};


#include "dal/mal/mal.h"
#include "dal/mal/mal_driver.h"

static vsf_err_t fakefat_drv_init(struct dal_info_t *info)
{
	struct mal_info_t *mal_info = (struct mal_info_t *)info->extra;
	
	mal_info->capacity.block_size = GET_LE_U16(&fat12_mbr[11]);
	mal_info->capacity.block_number = GET_LE_U16(&fat12_mbr[19]);
	
	// fix file size
	SET_LE_U32(&fat12_root[2 * 32 - 4], sizeof(fat12_file));
	return VSFERR_NONE;
}

static vsf_err_t fakefat_drv_fini(struct dal_info_t *info)
{
	return VSFERR_NONE;
}

static vsf_err_t fakefat_drv_readblock_nb_start(struct dal_info_t *info, 
											uint64_t address, uint64_t count)
{
	REFERENCE_PARAMETER(info);
	REFERENCE_PARAMETER(address);
	REFERENCE_PARAMETER(count);
	return VSFERR_NONE;
}

static vsf_err_t fakefat_drv_readblock_nb(struct dal_info_t *info, 
											uint64_t address, uint8_t *buff)
{
	struct mal_info_t *mal_info = (struct mal_info_t *)info->extra;
	uint32_t page_size = (uint32_t)mal_info->capacity.block_size;
	uint32_t copy_size = 0;
	uint8_t *copy_ptr = NULL;
	uint32_t block_addr;
	
	block_addr = (uint32_t)address / page_size;
	memset(buff, 0, page_size);
	switch (block_addr)
	{
	case 0:
		copy_size = sizeof(fat12_mbr);
		copy_ptr = (uint8_t *)fat12_mbr;
		break;
	case 1:
		copy_size = sizeof(fat12_fat);
		copy_ptr = (uint8_t *)fat12_fat;
		break;
	case 2:
		copy_size = sizeof(fat12_root);
		copy_ptr = (uint8_t *)fat12_root;
		break;
	case 4:
		copy_size = sizeof(fat12_file);
		copy_ptr = (uint8_t *)fat12_file;
		break;
	default:
		break;
	}
	
	if (copy_size && (copy_ptr != NULL))
	{
		if (page_size < copy_size)
		{
			copy_size = page_size;
		}
		memcpy(buff, copy_ptr, copy_size);
	}
	return VSFERR_NONE;
}

static vsf_err_t fakefat_drv_readblock_nb_isready(struct dal_info_t *info, 
												uint64_t address, uint8_t *buff)
{
	REFERENCE_PARAMETER(info);
	REFERENCE_PARAMETER(address);
	REFERENCE_PARAMETER(buff);
	return VSFERR_NONE;
}

static vsf_err_t fakefat_drv_readblock_nb_end(struct dal_info_t *info)
{
	REFERENCE_PARAMETER(info);
	return VSFERR_NONE;
}

static vsf_err_t fakefat_drv_writeblock_nb_start(struct dal_info_t *info, 
											uint64_t address, uint64_t count)
{
	REFERENCE_PARAMETER(info);
	REFERENCE_PARAMETER(address);
	REFERENCE_PARAMETER(count);
	return VSFERR_NONE;
}

static vsf_err_t fakefat_drv_writeblock_nb(struct dal_info_t *info, 
											uint64_t address, uint8_t *buff)
{
//	struct mal_info_t *mal_info = (struct mal_info_t *)info->extra;
	
	return VSFERR_NONE;
}

static vsf_err_t fakefat_drv_writeblock_nb_isready(struct dal_info_t *info, 
												uint64_t address, uint8_t *buff)
{
	REFERENCE_PARAMETER(info);
	REFERENCE_PARAMETER(address);
	REFERENCE_PARAMETER(buff);
	return VSFERR_NONE;
}

static vsf_err_t fakefat_drv_writeblock_nb_end(struct dal_info_t *info)
{
	REFERENCE_PARAMETER(info);
	return VSFERR_NONE;
}

#if DAL_INTERFACE_PARSER_EN
static vsf_err_t fakefat_drv_parse_interface(struct dal_info_t *info, 
												uint8_t *buff)
{
	return VSFERR_NONE;
}
#endif

struct mal_driver_t fakefat_drv = 
{
	{
		"fakefat",
#if DAL_INTERFACE_PARSER_EN
		"",
		fakefat_drv_parse_interface,
#endif
	},
	
	MAL_SUPPORT_WRITEBLOCK | MAL_SUPPORT_READBLOCK,
	
	fakefat_drv_init,
	NULL,
	fakefat_drv_fini,
	NULL,
	NULL,
	
	NULL, NULL, NULL, NULL,
	
	NULL, NULL, NULL, NULL,
	
	NULL, NULL, NULL, NULL, NULL,
	
	fakefat_drv_readblock_nb_start,
	fakefat_drv_readblock_nb,
	fakefat_drv_readblock_nb_isready,
	NULL,
	fakefat_drv_readblock_nb_end,
	
	fakefat_drv_writeblock_nb_start,
	fakefat_drv_writeblock_nb,
	fakefat_drv_writeblock_nb_isready,
	NULL,
	fakefat_drv_writeblock_nb_end
};
